CREATE TABLE PHICO (
    MAPC VARCHAR(10) NOT NULL PRIMARY KEY,
    TENPHICO VARCHAR(50) NOT NULL,
    KHOANGCACHBAY INT NOT NULL,
)

CREATE TABLE CHUYENBAY(
    MACB VARCHAR(10) NOT NULL PRIMARY KEY,
    MAPC VARCHAR(10) NOT NULL,
    NOIXP VARCHAR(50) NOT NULL,
    NoiDen VARCHAR(50) NOT NULL,
    GioXP DATETIME NOT NULL,
    GioDen DATETIME NOT NULL,
    FOREIGN KEY (MAPC) REFERENCES PHICO(MAPC)
)

CREATE TABLE NHANVIEN (
    MANV VARCHAR(10) NOT NULL PRIMARY KEY,
    HOTEN NVARCHAR(100) NOT NULL,
    NGAYSINH DATETIME NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    LUONGCB INT NOT NULL,
)

CREATE TABLE CHITIET_CHUYENBAY (
    MACB VARCHAR(10) NOT NULL,
    MANV VARCHAR(10) NOT NULL,
    PRIMARY KEY (MACB, MANV),
    FOREIGN KEY (MACB) REFERENCES CHUYENBAY(MACB),
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)

INSERT INTO PHICO VALUES 
('BL750', 'Airbus B320', 5000),
('QH228', 'Airbus B321', 1660),
('VJ144', 'Airbus C322', 2300),
('VN216', 'Airbus D323', 7000),
('VN238', 'Airbus D324', 5700),
('VN350', 'Airbus D325', 3000),
('VJ189', 'Airbus D326', 4000)

INSERT INTO CHUYENBAY VALUES 
('CBND.0001', 'VJ144', 'HANOI', 'TPHCM', '2019-10-24 07:00:00', '2019-10-24 10:00:00'),
('CBND.0002', 'QH228', 'HANOI', 'VINH', '2019-10-25 08:00:00', '2019-10-25 09:00:00'),
('CBND.0003', 'BL750', 'HANOI', 'DANANG', '2019-11-24 09:00:00', '2019-11-24 11:00:00'),
('CBND.0004', 'QH228', 'VINH', 'TPHCM', '2019-11-26 10:00:00', '2019-11-26 14:00:00'),
('CBND.0005', 'VN350', 'DANANG', 'VINH', '2019-11-20 11:00:00', '2019-11-20 12:00:00'),
('CBQT.0001', 'VN216', 'HANOI', 'TOKYO', '2020-01-24 07:00:00', '2020-01-24 13:00:00'),
('CBQT.0002', 'VN238', 'TOKYO', 'TPHCM', '2020-02-25 07:00:00', '2020-02-25 12:00:00'),
('CBQT.0003', 'VJ189', 'DANANG', 'TOKYO', '2020-03-24 15:00:00', '2020-03-24 23:00:00'),
('CBQT.0004', 'VN350', 'TOKYO', 'HANOI', '2020-03-15 17:00:00', '2020-03-16 02:00:00'),
('CBQT.0005', 'VJ189', 'SEOUL', 'HANOI', '2020-01-25 20:00:00', '2020-01-26 08:00:00'),
('CBQT.0006', 'VN350', 'HANOI', 'SEOUL', '2020-02-20 07:00:00', '2020-02-20 14:00:00')

INSERT INTO NHANVIEN VALUES
('MPC.001', N'Đào Duy Thịnh', '1985-05-15', N'30,Võ Nguyên Giáp', 50000),
('MPC.002', N'Phạm Thanh Bình','1985-05-13',N'17,Trần Nguyên Hãn', 70000 ),
('MPC.003', N'Nguyễn Thành Duy', '1904-05-12',N'253, Nguyễn Thái Học', 50000),
('MPC.004', N'Bùi Trọng Trung', '1981-05-10', N'32, Nguyễn Công Trứ', 70000),
('MPC.005', N'Nguyễn Đức Dũng', '1987-05-30', N'17, Hồ Xuân Hương', 70000),
('MTV.001', N'Nguyễn Hà Nam', '1989-05-10', N'78, Định Công', 45000)

INSERT INTO CHITIET_CHUYENBAY VALUES
('CBND.0001', 'MPC.001'),
('CBND.0001', 'MTV.001'),
('CBND.0003', 'MPC.005'),
('CBND.0003', 'MTV.001'),
('CBQT.0001', 'MPC.004')

--1--
SELECT DISTINCT pc.MAPC, pc.TENPHICO, pc.KHOANGCACHBAY
FROM PHICO pc, CHUYENBAY cb
WHERE pc.MAPC = cb.MAPC 
AND pc.KHOANGCACHBAY BETWEEN 1000 AND 5000
AND YEAR(cb.GioXP) = 2020

--2--
SELECT cb.MACB, cb.NOIXP, cb.NoiDen, cb.GioXP, cb.GioDen, pc.TENPHICO, COUNT(ccb.MANV) AS SoLuongNV
FROM CHUYENBAY cb, CHITIET_CHUYENBAY ccb, PHICO pc
WHERE cb.MACB = ccb.MACB
AND pc.MAPC = cb.MAPC
AND cb.NOIXP = 'HANOI'
AND YEAR(cb.GioXP) = 2019
GROUP BY cb.MACB, cb.NOIXP, cb.NoiDen, cb.GioXP, cb.GioDen, pc.TENPHICO
HAVING COUNT(ccb.MANV) >= 2

--3--
SELECT nv.MANV, nv.HOTEN, nv.NGAYSINH,COUNT(ccb.MACB) AS SoLuongCB, COUNT(ccb.MACB) * nv.LUONGCB AS TongLuong
FROM NHANVIEN nv, CHITIET_CHUYENBAY ccb, CHUYENBAY cb
WHERE nv.MANV = ccb.MANV
AND cb.MACB = ccb.MACB
AND YEAR(cb.GioXP) = 2020
AND MONTH(cb.GioXP) BETWEEN 1 AND 6
GROUP BY ccb.MANV,nv.MANV, nv.HOTEN, nv.NGAYSINH, ccb.MACB, nv.LUONGCB

--4--
SELECT PC.MAPC, PC.TENPHICO 
FROM PHICO PC, CHUYENBAY CB
WHERE PC.MAPC = CB.MAPC
AND YEAR(CB.GioXP) = 2020
GROUP BY CB.MAPC, PC.TENPHICO, PC.MAPC
HAVING COUNT(CB.MAPC) >= ALL(
    SELECT COUNT(CB.MAPC)
    FROM PHICO PC, CHUYENBAY CB
    WHERE PC.MAPC = CB.MAPC
    AND YEAR(CB.GioXP) = 2020
    GROUP BY CB.MAPC
)

--5--
SELECT nv.MANV, nv.HOTEN, nv.NGAYSINH, ccb.MACB
FROM NHANVIEN nv, CHITIET_CHUYENBAY ccb, CHUYENBAY cb
WHERE nv.MANV = ccb.MANV
AND cb.MACB = ccb.MACB
AND YEAR(cb.GioXP) BETWEEN 2015 AND 2020
GROUP BY ccb.MANV, nv.MANV, nv.HOTEN, nv.NGAYSINH, ccb.MACB, nv.LUONGCB
HAVING COUNT(ccb.MACB) = (
    SELECT COUNT(cb.MACB)
    FROM CHUYENBAY cb
)

--6--
SELECT MAPC
FROM PHICO 
WHERE MAPC NOT IN (
    SELECT pc.MAPC
    FROM PHICO pc, CHUYENBAY cb
    WHERE pc.MAPC = cb.MAPC
    AND YEAR(cb.GioXP) = 2020 
    )

--7--
SELECT *
FROM CHUYENBAY
WHERE DATEDIFF(DAY,GioXP,GioDen) * 24 + DATEDIFF(HOUR,GioXP,GioDen) <= 6